---
title: "ARTICLE SUPPLEMENTARY FILES"
author: "Selcen ArÄ± Yuka"
date: "2023-06-07"
output: html_document
---

This document describes the analysis of fluctuating ceRNA interactions in 3 cancer types.

An example workflow for the sparse partial correlation phase is included in sponge_starbase.R which must be run before the analyses in this file.

#### Required Packages:

```{r}
library(tidyverse)
library(fs)
library(ggraph)
library(tidygraph)
library(SummarizedExperiment)
library(EnhancedVolcano)
library(DESeq2)
library(fgsea)
library("BiocParallel")
library(pheatmap)
library(msigdbr)
library(ggVennDiagram)
```

NOTE: The following were obtained to be used for pathway enrichment analysis. Please check the manual of the msigdbr package for details.

```{r, message=FALSE, warning=FALSE}
pathways_hallmark <- fgsea::gmtPathways("data/h_all_v2023_1_Hs_symbols.gmt")
pathways_kegg <- fgsea::gmtPathways("data/c2.cp.kegg.v2023.1.Hs.symbols.gmt")
```

-----------------

# CHAPTER1:

## 1. NORMAL TISSUE ANALYSIS

```{r}
##Get the data
cerna_pattern_normal <- readRDS("data/cerna_pattern_normal.RDS")
starbase_pairs <- readRDS("data/starbase_pairs.RDS") # the old name is starbase, new one is ENCORI
all_starbase_data <- readRDS("data/all_starbase_data.RDS")
```

### 1.1 Lung

```{r, message=FALSE, warning=FALSE}

type = "LUAD"

tissue <- cerna_pattern_normal %>% 
  filter(tissue == type)


starbase_pairs %>% 
  filter(geneID%in% unique(tissue$geneA) | geneID%in% unique(tissue$geneB)) %>% 
  left_join(dplyr::select(all_starbase_data, miRNAid, miRNAname), by = "miRNAid") %>% 
  distinct() %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = "geneID") %>% 
  distinct()->tissue_cerna

unique(tissue_cerna$miRNAname)
unique(tissue_cerna$geneName)

length(unique(tissue_cerna$geneID))
```

```{r, message=FALSE, warning=FALSE, fig.align='center'}
tissue_cerna %>% 
  group_by(miRNAname, geneID) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% ## to ensure one-to-one id and name match
  ungroup() %>% 
  select(miRNAname, geneName) %>% 
  tidygraph::as_tbl_graph() ->tissue_gr

tissue_gr %>% 
  mutate(group=group_edge_betweenness()) ->tissue_gr

tissue_gr %>% 
  mutate(centrality = centrality_degree(mode = "all")) %>% 
  group_by(group) %>% 
  mutate(parcipitant = dplyr::row_number(),
         parcipitant=max(parcipitant)) %>% 
  ungroup() %>% 
  filter(parcipitant>2) %>% 
  mutate(type = ifelse(str_detect(name,"hsa"), "mirna", "competing")) ->tissue_gr2

tissue_gr2 %>% pull(group) %>% unique() -> group_v

length(group_v)

### selected clusters: 1, 2, 9, 10, 13

for (i in c(1, 2, 9, 10, 13)) {

graph <- tissue_gr2 %>% 
  mutate(name = ifelse(startsWith(name, "hsa-"), str_remove(name, "hsa-"), name)) %>% 
  filter(group==i) %>%
  ggraph::ggraph(layout = "kk")+
  geom_edge_bend(color="grey")+
  geom_node_point(aes(filter=(type == "mirna")), shape=18, size = 7, color="navy", alpha = 0.7)+
  geom_node_point(aes(filter=(type == "competing")), shape=15, size = 7, color="chocolate4", alpha = 0.7)+
  geom_node_text(aes(filter=(type == "mirna"), label = name), color="midnightblue", size = 6, repel = TRUE)+
  geom_node_text(aes(filter=(type == "competing"), label = name), color="darkslategrey", size = 6, repel = TRUE)+
  theme_graph(base_family = "sans", plot_margin = margin(0, 0, 0, 0))+
  theme(legend.position = "none")

print(graph)

ggsave(paste0("lung_", i, ".svg"), height = 12, width = 15)

}

```


### 1.2 Prostate

```{r, message=FALSE, warning=FALSE}

type = "PRAD"

tissue <- cerna_pattern_normal %>% 
  filter(tissue == type)


starbase_pairs %>% 
  filter(geneID%in% unique(tissue$geneA) | geneID%in% unique(tissue$geneB)) %>% 
  left_join(dplyr::select(all_starbase_data, miRNAid, miRNAname), by = "miRNAid") %>% 
  distinct() %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = "geneID") %>% 
  distinct()->tissue_cerna

unique(tissue_cerna$miRNAname)
unique(tissue_cerna$geneName)

length(unique(tissue_cerna$geneID))
```


```{r, message=FALSE, warning=FALSE, fig.align='center'}
tissue_cerna %>% 
  group_by(miRNAname, geneID) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% ## to ensure one-to-one id and name match
  ungroup() %>% 
  select(miRNAname, geneName) %>% 
  tidygraph::as_tbl_graph() ->tissue_gr

tissue_gr %>% 
  mutate(group=group_edge_betweenness()) ->tissue_gr

tissue_gr %>% 
  mutate(centrality = centrality_degree(mode = "all")) %>% 
  group_by(group) %>% 
  mutate(parcipitant = dplyr::row_number(),
         parcipitant=max(parcipitant)) %>% 
  ungroup() %>% 
  filter(parcipitant>2) %>% 
  mutate(type = ifelse(str_detect(name,"hsa"), "mirna", "competing")) ->tissue_gr2

tissue_gr2 %>% pull(group) %>% unique() -> group_v

length(group_v)

### selected clusters: 2,4,5,6

for (i in c(2,4,5,6)) {

graph <- tissue_gr2 %>% 
  mutate(name = ifelse(startsWith(name, "hsa-"), str_remove(name, "hsa-"), name)) %>% 
  filter(group==i) %>%
  ggraph::ggraph(layout = "kk")+
  geom_edge_bend(color="grey")+
  geom_node_point(aes(filter=(type == "mirna")), shape=18, size = 7, color="navy", alpha = 0.7)+
  geom_node_point(aes(filter=(type == "competing")), shape=15, size = 7, color="chocolate4", alpha = 0.7)+
  geom_node_text(aes(filter=(type == "mirna"), label = name), color="midnightblue", size = 6, repel = TRUE)+
  geom_node_text(aes(filter=(type == "competing"), label = name), color="darkslategrey", size = 6, repel = TRUE)+
  theme_graph(base_family = "sans", plot_margin = margin(0, 0, 0, 0))+
  theme(legend.position = "none")


print(graph)

ggsave(paste0("prostate_", i, ".svg"), height = 5, width = 5)


}

```

### 1.3 Breast

```{r, message=FALSE, warning=FALSE}

type = "BRCA"

tissue <- cerna_pattern_normal %>% 
  filter(tissue == type)


starbase_pairs %>% 
  filter(geneID%in% unique(tissue$geneA) | geneID%in% unique(tissue$geneB)) %>% 
  left_join(dplyr::select(all_starbase_data, miRNAid, miRNAname), by = "miRNAid") %>% 
  distinct() %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = "geneID") %>% 
  distinct()->tissue_cerna

unique(tissue_cerna$miRNAname)
unique(tissue_cerna$geneName)

length(unique(tissue_cerna$geneID))
```


```{r, message=FALSE, warning=FALSE, fig.align='center'}
tissue_cerna %>% 
  group_by(miRNAname, geneID) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% ## to ensure one-to-one id and name match
  ungroup() %>% 
  select(miRNAname, geneName) %>% 
  tidygraph::as_tbl_graph() ->tissue_gr

tissue_gr %>% 
  mutate(group=group_edge_betweenness()) ->tissue_gr

tissue_gr %>% 
  mutate(centrality = centrality_degree(mode = "all")) %>% 
  group_by(group) %>% 
  mutate(parcipitant = dplyr::row_number(),
         parcipitant=max(parcipitant)) %>% 
  ungroup() %>% 
  filter(parcipitant>2) %>% 
  mutate(type = ifelse(str_detect(name,"hsa"), "mirna", "competing")) ->tissue_gr2

tissue_gr2 %>% pull(group) %>% unique() -> group_v

length(group_v)

### selected clusters: 1,3,4,5,6,7

for (i in c(1,3,4,5,6,7)) {

graph <- tissue_gr2 %>% 
  mutate(name = ifelse(startsWith(name, "hsa-"), str_remove(name, "hsa-"), name)) %>% 
  filter(group==i) %>%
  ggraph::ggraph(layout = "kk")+
  geom_edge_bend(color="grey")+
  geom_node_point(aes(filter=(type == "mirna")), shape=18, size = 7, color="navy", alpha = 0.7)+
  geom_node_point(aes(filter=(type == "competing")), shape=15, size = 7, color="chocolate4", alpha = 0.7)+
  geom_node_text(aes(filter=(type == "mirna"), label = name), color="midnightblue", size = 6, repel = TRUE)+
  geom_node_text(aes(filter=(type == "competing"), label = name), color="darkslategrey", size = 6, repel = TRUE)+
  theme_graph(base_family = "sans", plot_margin = margin(0, 0, 0, 0))+
  theme(legend.position = "none")

print(graph)

ggsave(paste0("breast_", i, ".svg"), height = 5, width = 7)

}

```


## 2. TUMOR TISSUE ANALYSIS

```{r}

cerna_pattern_cancer <- readRDS("data/cerna_pattern_cancer.RDS")

`%notin%` = Negate(`%in%`)
```

### 2.1 LUAD 

```{r, message=FALSE, warning=FALSE}
type = "LUAD"

cancer <- cerna_pattern_cancer %>% 
  filter(tissue == type)


starbase_pairs %>% 
  filter(geneID%in% unique(cancer$geneA) | geneID%in% unique(cancer$geneB)) %>% 
  left_join(dplyr::select(all_starbase_data, miRNAid, miRNAname), by = "miRNAid") %>% 
  distinct() %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = "geneID") %>% 
  distinct()->cancer_cerna

length(unique(cancer_cerna$miRNAname))
length(unique(cancer_cerna$geneID))
# 641 miRNA 3270 ceRNA
```

```{r, message=FALSE, warning=FALSE, fig.align='center'}
cancer_cerna %>% 
  group_by(miRNAname, geneID) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  select(miRNAname, geneName) %>% 
  tidygraph::as_tbl_graph() ->cancer_gr

cancer_gr %>% 
  mutate(group=group_edge_betweenness()) ->cancer_gr


cancer_gr %>% 
  mutate(centrality = centrality_degree(mode = "all")) %>% 
  group_by(group) %>% 
  mutate(parcipitant = dplyr::row_number(),
         parcipitant=max(parcipitant)) %>% 
  ungroup() %>% 
  filter(parcipitant>2) %>% 
  mutate(type = ifelse(str_detect(name,"hsa"), "mirna", "competing")) ->cancer_gr2

cancer_gr2 %>% pull(group) %>% unique() -> group_v

length(group_v)


for (i in c(2, 3, 9, 6,  8, 7 ,4)) {

graph <- cancer_gr2 %>% 
  mutate(name = ifelse(startsWith(name, "hsa-"), str_remove(name, "hsa-"), name)) %>% 
  filter(group==i) %>%
  ggraph::ggraph(layout = "kk")+
  geom_edge_bend(color="grey")+
  geom_node_point(aes(color = type, shape = type), size =5)+
  geom_node_text(aes(label = name, fill ="navy", shape=type), label.size = 0.25, size = 3, repel = TRUE)+
  theme_graph(base_family = "sans", plot_margin = margin(0, 0, 0, 0))+
  theme(legend.position = "none")

print(graph)

ggsave(paste0("luad_", i, ".png"), height = 4, width = 5)

}
 
```

### 2.2 PRAD

```{r, message=FALSE, warning=FALSE}
type = "PRAD"

cancer <- cerna_pattern_cancer %>% 
  filter(tissue == type)


starbase_pairs %>% 
  filter(geneID%in% unique(cancer$geneA) | geneID%in% unique(cancer$geneB)) %>% 
  left_join(dplyr::select(all_starbase_data, miRNAid, miRNAname), by = "miRNAid") %>% 
  distinct() %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = "geneID") %>% 
  distinct()->cancer_cerna

length(unique(cancer_cerna$miRNAid))
length(unique(cancer_cerna$geneID))
```


```{r, message=FALSE, warning=FALSE, fig.align='center'}
cancer_cerna %>% 
  group_by(miRNAname, geneID) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  select(miRNAname, geneName) %>% 
  tidygraph::as_tbl_graph() ->cancer_gr

cancer_gr %>% 
  mutate(group=group_edge_betweenness()) ->cancer_gr


cancer_gr %>% 
  mutate(centrality = centrality_degree(mode = "all")) %>% 
  group_by(group) %>% 
  mutate(parcipitant = dplyr::row_number(),
         parcipitant=max(parcipitant)) %>% 
  ungroup() %>% 
  filter(parcipitant>2) %>% 
  mutate(type = ifelse(str_detect(name,"hsa"), "mirna", "competing")) ->cancer_gr2

cancer_gr2 %>% pull(group) %>% unique() -> group_v

length(group_v)

for (i in c(3,4,5,6,7)) {

graph <- cancer_gr2 %>% 
  mutate(name = ifelse(startsWith(name, "hsa-"), str_remove(name, "hsa-"), name)) %>% 
  filter(group==i) %>%
  ggraph::ggraph(layout = "kk")+
  geom_edge_bend(color="grey")+
  geom_node_point(aes(color = type, shape = type), size =5)+
  geom_node_text(aes(label = name, fill ="navy", shape=type), label.size = 0.25, size = 3, repel = TRUE)+
  theme_graph(base_family = "sans", plot_margin = margin(0, 0, 0, 0))+
  theme(legend.position = "none")

print(graph)

ggsave(paste0("prad_", i, ".png"), height = 4, width = 5)

}

```

### 2.3 BRCA

```{r, message=FALSE, warning=FALSE}

type = "BRCA"

cancer <- cerna_pattern_cancer %>% 
  filter(tissue == type)


starbase_pairs %>% 
  filter(geneID %in% unique(cancer$geneA) | geneID%in% unique(cancer$geneB)) %>% 
  left_join(dplyr::select(all_starbase_data, miRNAid, miRNAname), by = "miRNAid") %>% 
  distinct() %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = "geneID") %>% 
  distinct()->cancer_cerna

length(unique(cancer_cerna$miRNAid))
length(unique(cancer_cerna$geneID))
```


```{r, message=FALSE, warning=FALSE, fig.align='center'}
cancer_cerna %>% 
  group_by(miRNAname, geneID) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  select(miRNAname, geneName) %>% 
  tidygraph::as_tbl_graph() ->cancer_gr

cancer_gr %>% 
  mutate(group=group_edge_betweenness()) ->cancer_gr


cancer_gr %>% 
  mutate(centrality = centrality_degree(mode = "all")) %>% 
  group_by(group) %>% 
  mutate(parcipitant = dplyr::row_number(),
         parcipitant=max(parcipitant)) %>% 
  ungroup() %>% 
  filter(parcipitant>2) %>% 
  mutate(type = ifelse(str_detect(name,"hsa"), "mirna", "competing")) ->cancer_gr2

cancer_gr2 %>% pull(group) %>% unique() -> group_v

length(group_v)


for (i in group_v) {

graph <- cancer_gr2 %>% 
  mutate(name = ifelse(startsWith(name, "hsa-"), str_remove(name, "hsa-"), name)) %>% 
  filter(group==i) %>%
  ggraph::ggraph(layout = "kk")+
  geom_edge_bend(color="grey")+
  geom_node_point(aes(color = type, shape = type), size =5)+
  geom_node_text(aes(label = name, fill ="navy", shape=type), label.size = 0.25, size = 3, repel = TRUE)+
  theme_graph(base_family = "sans", plot_margin = margin(0, 0, 0, 0))+
  theme(legend.position = "none")

print(graph)

ggsave(paste0("brca_", i, ".png"), height = 4, width = 5)

}

```


-----------------

# CHAPTER2: COMPARISON OF TISSUE AND CONDITION SPECIFIC ceRNA FLUCTUATION

### 3.1 LUAD:

```{r, message=FALSE, warning=FALSE}

length(intersect(unique(c(filter(cerna_pattern_cancer, tissue == "LUAD")$geneA, filter(cerna_pattern_cancer, tissue == "LUAD")$geneB)), unique(c(filter(cerna_pattern_normal, tissue == "LUAD")$geneA, filter(cerna_pattern_normal, tissue == "LUAD")$geneB))))

length(setdiff(unique(c(filter(cerna_pattern_cancer, tissue == "LUAD")$geneA, filter(cerna_pattern_cancer, tissue == "LUAD")$geneB)), unique(c(filter(cerna_pattern_normal, tissue == "LUAD")$geneA, filter(cerna_pattern_normal, tissue == "LUAD")$geneB))))

length(setdiff(unique(c(filter(cerna_pattern_normal, tissue == "LUAD")$geneA, filter(cerna_pattern_normal, tissue == "LUAD")$geneB)), unique(c(filter(cerna_pattern_cancer, tissue == "LUAD")$geneA, filter(cerna_pattern_cancer, tissue == "LUAD")$geneB))))

```


```{r, message=FALSE, warning=FALSE}
type <- "LUAD"

luad_specific <- setdiff(unique(c(filter(cerna_pattern_cancer, tissue == "LUAD")$geneA, filter(cerna_pattern_cancer, tissue == "LUAD")$geneB)), unique(c(filter(cerna_pattern_normal, tissue == "LUAD")$geneA, filter(cerna_pattern_normal, tissue == "LUAD")$geneB)))

cancer <- cerna_pattern_cancer %>% 
  filter(tissue == type) %>% 
  filter(geneA %in% luad_specific | geneB %in% luad_specific)
  

starbase_pairs %>% 
  filter(geneID%in% luad_specific) %>% 
  left_join(dplyr::select(all_starbase_data, miRNAid, miRNAname), by = "miRNAid") %>% 
  distinct() %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = "geneID") %>% 
  distinct()->cancer_cerna

cancer_cerna
```

#### LUAD DEG

Let's check the DEG profiles of the ceRNAs:

```{r, message=FALSE, warning=FALSE}

tcga_project_normal <-readRDS("data/tcga_project_normal.RDS") 

data_info_gen <- readRDS("data/data_info_gen.RDS")

all_tcga_normal <- as.data.frame(assay(tcga_project_normal))
rm(tcga_project_normal)
```


```{r, message=FALSE, warning=FALSE}

genes <- luad_specific

project_can <- "LUAD"

colnames(all_tcga_normal) <- substr(colnames(all_tcga_normal), 1,16) 

all_tcga_normal%>%
  dplyr::filter(!str_detect(row.names(.), "PAR")) %>% 
  mutate(gene_id = rownames(.)) %>% 
  separate(gene_id, into = c("ensemb_gene_id", "version")) %>% 
  dplyr::select(-version) ->all_tcga_normal

rownames(all_tcga_normal) <-all_tcga_normal$ensemb_gene_id

rownames(all_tcga_normal) <- str_trim(rownames(all_tcga_normal), side = "both")


all_tcga_normal %>% 
  dplyr::select(-ensemb_gene_id)-> all_tcga_normal

project_samples <- (data_info_gen %>% filter(str_detect(project, project_can)))$sample.submitter_id

all_tcga_normal %>% 
  dplyr::select(project_samples) %>% filter(rownames(.) %in% genes)-> all_tcga_normal

```

NOTE: These datasets have been uploaded to zenodo due to github size limitation. Download from the link.

```{r, message=FALSE, warning=FALSE}
log_new <- function(x){return(log2(x+1))}

string <- paste0("data/tcga_tumor_exp_", tolower(project_can), ".RDS")

readRDS(string)->project_tumor_exp

all_tcga_tumor <- as.data.frame(assay(project_tumor_exp))

rm(project_tumor_exp)


all_tcga_tumor%>%
  dplyr::select(contains("-01A-"))-> all_tcga_tumor
    
colnames(all_tcga_tumor)<- substr(colnames(all_tcga_tumor), 1,16)

colnames(all_tcga_tumor) %>% as_tibble() %>% group_by(value) %>% dplyr::count() %>% arrange(desc(n)) %>% filter(n>1) %>% pull(value)->discarded

all_tcga_tumor <- dplyr::select(all_tcga_tumor, -discarded)

all_tcga_tumor %>%  
  filter(!str_detect(row.names(.), "PAR")) %>% 
  mutate(gene_id = rownames(.)) %>% 
  separate(gene_id, into = c("ensemb_gene_id", "version")) %>% 
  dplyr::select(-version) %>% 
  filter(ensemb_gene_id %in% genes) %>% 
  group_by(ensemb_gene_id) %>% 
  mutate_at(vars(contains("TCGA")), .funs = max) %>% 
  ungroup() %>% 
  distinct() ->all_tcga_tumor

```

```{r, message=FALSE, warning=FALSE}

all_tcga_normal %>% 
  mutate(ensemb_gene_id =row.names(.)) %>% 
  left_join(all_tcga_tumor, by = "ensemb_gene_id")->dea_input

row.names(dea_input) <- dea_input$ensemb_gene_id

dplyr::select(dea_input, -ensemb_gene_id)->dea_input

```

```{r, message=FALSE, warning=FALSE}
data.frame(sample_id = c(colnames(dea_input))) %>% 
  mutate(condition = ifelse(str_detect(sample_id, paste(c("-11A", "-11B"),collapse = '|')), "normal", "tumor"))->coldata

row.names(coldata) <- coldata$sample_id
```


```{r, message=FALSE, warning=FALSE}
library(DESeq2)
dds <- DESeqDataSetFromMatrix(countData = dea_input,
                              colData = coldata,
                              design = ~ condition)


dds_luad <- DESeq(dds)
res_luad <- results(dds_luad, tidy = TRUE)

summary(res_luad)
```

```{r}
res_luad %>% 
  filter(row %in% luad_specific) %>% 
  filter(log2FoldChange   < -1, pvalue < 0.05)

## down 113,248 up
```

```{r, message=FALSE, warning=FALSE, fig.width=8, fig.height=8}
library(scales)

res_luad %>% 
  filter(padj< 0.05) %>% 
  filter(abs(log2FoldChange) > 1)-> deg_all 

res_all2 <- deg_all %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = c("row"="geneID")) %>%  
  dplyr::select(geneName, stat) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(geneName) %>% 
  summarize(stat=mean(stat))

ranks <- deframe(res_all2)

register(SerialParam())

gsea_res <- fgsea(pathways=pathways_hallmark, stats=ranks)

fgseaResTidy <- gsea_res %>%
  as_tibble() %>%
  arrange(desc(NES))

hallmark <- fgseaResTidy %>% 
  mutate(pathway = str_remove(pathway, "HALLMARK_")) %>% 
  filter(pval<0.05) %>% 
ggplot(aes(reorder(pathway, NES), NES)) +
  geom_point(aes(fill= pval, size = 1/pval)) +
  geom_label(aes(label = round(pval, 5)), size= 3, repel =TRUE, nudge_x = 0.3)+
  coord_flip() +
  labs(title="Hallmarks") + 
  theme_minimal()+
   theme(text = element_text(size=15, face = "bold"), legend.position = "none", axis.title.y = element_blank())

```


```{r, message=FALSE, warning=FALSE, fig.width=12, fig.height=12}
register(SerialParam())

gsea_res <- fgsea(pathways=pathways_kegg, stats=ranks)

fgseaResTidy <- gsea_res %>%
  as_tibble() %>%
  arrange(desc(NES))

kegg <- fgseaResTidy %>% 
  mutate(pathway = str_remove(pathway, "KEGG_")) %>% 
  filter(pval<0.05) %>% 
  ggplot(aes(reorder(pathway, NES), NES)) +
  geom_point(aes(fill= pval, size = 1/pval)) +
  geom_label(aes(label = round(pval, 5)), size= 3, repel =TRUE, nudge_x = 0.3)+
  coord_flip() +
  labs(title="KEGG pathways") +
  xlab("Pathways")+
  theme_minimal()+
   theme(text = element_text(size=15, face = "bold"), legend.position = "none")

ggsave(paste0("luad_361_dea_kegg.svg"), plot = kegg, height = 7, width = 12)
ggsave(paste0("luad_361_dea_hallmark.svg"), plot = hallmark, height = 7, width = 12)
```


```{r}
#install.packages("svglite")
library(svglite)
require(gridExtra)
graph_path<- grid.arrange(kegg, hallmark, nrow=2)

ggsave(paste0("luad_361_dea_genes.svg"), plot = graph_path, height = 7, width = 17)
```

#### Construction of Subnetworks

```{r, message=FALSE, warning=FALSE, fig.align='center'}
cancer_cerna %>% 
  group_by(miRNAname, geneID) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  select(miRNAname, geneName) %>% 
  tidygraph::as_tbl_graph() ->cancer_gr

cancer_gr %>% 
  mutate(group=group_edge_betweenness()) ->cancer_gr

cancer_gr %>% 
  filter(str_detect(name, "hsa-"))


cancer_gr %>% 
  mutate(centrality = centrality_degree(mode = "all")) %>% 
  group_by(group) %>% 
  mutate(parcipitant = dplyr::row_number(),
         parcipitant=max(parcipitant)) %>% 
  ungroup() %>% 
  filter(parcipitant>2) %>% 
  mutate(type = ifelse(str_detect(name,"hsa"), "mirna", "competing")) ->cancer_gr2

cancer_gr2 %>% pull(group) %>% unique() -> group_v


for (i in group_v) {

graph <- cancer_gr2 %>% 
  mutate(name = str_remove(name, "hsa-")) %>% 
  filter(group==i) %>% 
  ggraph::ggraph(layout = "kk")+  ### 4th figure geom_edge_diagonal for clear demonstration
  geom_edge_bend(color="grey")+
  geom_node_point(aes(filter=(type == "mirna")), shape=18, size = 7, color="navy", alpha = 0.7)+
  geom_node_point(aes(filter=(type == "competing")), shape=15, size = 7, color="chocolate4", alpha = 0.7)+
  geom_node_text(aes(filter=(type == "mirna"), label = name), color="midnightblue", size = 6, repel = TRUE)+
  geom_node_text(aes(filter=(type == "competing"), label = name), color="darkslategrey", size = 6, repel = TRUE)+
  #geom_node_label(aes(label = name, fill==type), color = "white", label.size = 0.50, size = 2)+
  theme_graph(base_family = "sans", plot_margin = margin(0, 0, 0, 0), title_margin = 2)+
  #ggtitle(paste0("LUAD vs lung: ceRNA pattern ", i))+
  theme(legend.position = "none")

cancer_gr2 %>% 
  filter(group==i) %>% 
  filter(!str_detect(name, "hsa")) %>% 
  pull(name)->genes_part

dea_input %>% 
  mutate(row = row.names(.)) %>% 
  left_join(dplyr::select(cancer_cerna, geneID, geneName), by =c("row"="geneID")) %>% 
  distinct() %>% 
  select(geneName, contains("TCGA")) %>% 
  filter(geneName%in%genes_part) %>% 
  pivot_longer(contains("TCGA"), values_to = "exp", names_to = "samples")-> exp_graph


graph2 <- exp_graph %>% 
  left_join(coldata, by = c("samples"="sample_id")) %>% 
  ggplot(aes(x=geneName, y=log2(exp), fill=condition)) +
  geom_boxplot()+
  scale_fill_manual(values = c(normal = 'darkgreen', 
                               tumor = 'darkred'))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 60, hjust=1, size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.y = element_text(size = 20))+
  theme(legend.position = "none", axis.title.x = element_blank())

require(gridExtra)
graph3<- grid.arrange(graph, graph2, nrow=2)

ggsave(paste0("LUAD_vs_lung_", i, ".svg"), plot = graph3, height = 7, width = 5)

}
 
```

### 3.2 PRAD:

```{r, message=FALSE, warning=FALSE}

length(intersect(unique(c(filter(cerna_pattern_cancer, tissue == "PRAD")$geneA, filter(cerna_pattern_cancer, tissue == "PRAD")$geneB)), unique(c(filter(cerna_pattern_normal, tissue == "PRAD")$geneA, filter(cerna_pattern_normal, tissue == "PRAD")$geneB))))

length(setdiff(unique(c(filter(cerna_pattern_cancer, tissue == "PRAD")$geneA, filter(cerna_pattern_cancer, tissue == "PRAD")$geneB)), unique(c(filter(cerna_pattern_normal, tissue == "PRAD")$geneA, filter(cerna_pattern_normal, tissue == "PRAD")$geneB))))

length(setdiff(unique(c(filter(cerna_pattern_normal, tissue == "PRAD")$geneA, filter(cerna_pattern_normal, tissue == "PRAD")$geneB)), unique(c(filter(cerna_pattern_cancer, tissue == "PRAD")$geneA, filter(cerna_pattern_cancer, tissue == "PRAD")$geneB))))


```


```{r, message=FALSE, warning=FALSE}
type <- "PRAD"

prad_specific <- setdiff(unique(c(filter(cerna_pattern_cancer, tissue == "PRAD")$geneA, filter(cerna_pattern_cancer, tissue == "PRAD")$geneB)), unique(c(filter(cerna_pattern_normal, tissue == "PRAD")$geneA, filter(cerna_pattern_normal, tissue == "PRAD")$geneB)))


cancer <- cerna_pattern_cancer %>% 
  filter(tissue == type) %>% 
  filter(geneA %in% prad_specific | geneB %in% prad_specific)
  

starbase_pairs %>% 
  filter(geneID %in% prad_specific) %>% 
  left_join(dplyr::select(all_starbase_data, miRNAid, miRNAname), by = "miRNAid") %>% 
  distinct() %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = "geneID") %>% 
  distinct()->cancer_cerna

cancer_cerna
```

#### PRAD DEG

Let's check the DEG profiles of the ceRNAs:

```{r, message=FALSE, warning=FALSE}

tcga_project_normal <-readRDS("data/tcga_project_normal.RDS") 

data_info_gen <- readRDS("data/data_info_gen.RDS")

all_tcga_normal <- as.data.frame(assay(tcga_project_normal))
rm(tcga_project_normal)
```


```{r, message=FALSE, warning=FALSE}

genes <- prad_specific

project_can <- "PRAD"

colnames(all_tcga_normal) <- substr(colnames(all_tcga_normal), 1,16) 

all_tcga_normal%>%
  dplyr::filter(!str_detect(row.names(.), "PAR")) %>% 
  mutate(gene_id = rownames(.)) %>% 
  separate(gene_id, into = c("ensemb_gene_id", "version")) %>% 
  dplyr::select(-version) ->all_tcga_normal

rownames(all_tcga_normal) <-all_tcga_normal$ensemb_gene_id

rownames(all_tcga_normal) <- str_trim(rownames(all_tcga_normal), side = "both")


all_tcga_normal %>% 
  dplyr::select(-ensemb_gene_id)-> all_tcga_normal



project_samples <- (data_info_gen %>% filter(str_detect(project, project_can)))$sample.submitter_id

all_tcga_normal %>% 
  dplyr::select(project_samples) %>% filter(rownames(.) %in% genes)-> all_tcga_normal


```

NOTE: These datasets have been uploaded to zenodo due to github size limitation. Download from the link.

```{r, message=FALSE, warning=FALSE}
log_new <- function(x){return(log2(x+1))}

string <- paste0("data/tcga_tumor_exp_", tolower(project_can), ".RDS")

readRDS(string)->project_tumor_exp

all_tcga_tumor <- as.data.frame(assay(project_tumor_exp))

rm(project_tumor_exp)


all_tcga_tumor%>%
  dplyr::select(contains("-01A-"))-> all_tcga_tumor
    
colnames(all_tcga_tumor)<- substr(colnames(all_tcga_tumor), 1,16)

colnames(all_tcga_tumor) %>% as_tibble() %>% group_by(value) %>% dplyr::count() %>% arrange(desc(n)) %>% filter(n>1) %>% pull(value)->discarded

all_tcga_tumor <- dplyr::select(all_tcga_tumor, -discarded)

all_tcga_tumor %>%  
  filter(!str_detect(row.names(.), "PAR")) %>% 
  mutate(gene_id = rownames(.)) %>% 
  separate(gene_id, into = c("ensemb_gene_id", "version")) %>% 
  dplyr::select(-version) %>% 
  filter(ensemb_gene_id %in% genes) %>% 
  group_by(ensemb_gene_id) %>% 
  mutate_at(vars(contains("TCGA")), .funs = max) %>% 
  ungroup() %>% 
  distinct() ->all_tcga_tumor

```

```{r, message=FALSE, warning=FALSE}

all_tcga_normal %>% 
  mutate(ensemb_gene_id =row.names(.)) %>% 
  left_join(all_tcga_tumor, by = "ensemb_gene_id")->dea_input

row.names(dea_input) <- dea_input$ensemb_gene_id

dplyr::select(dea_input, -ensemb_gene_id)->dea_input

```

```{r, message=FALSE, warning=FALSE}
data.frame(sample_id = c(colnames(dea_input))) %>% 
  mutate(condition = ifelse(str_detect(sample_id, paste(c("-11A", "-11B"),collapse = '|')), "normal", "tumor"))->coldata

row.names(coldata) <- coldata$sample_id

```


```{r, message=FALSE, warning=FALSE}
library(DESeq2)
dds <- DESeqDataSetFromMatrix(countData = dea_input,
                              colData = coldata,
                              design = ~ condition)


dds_prad <- DESeq(dds)
res_prad <- results(dds_prad, tidy = TRUE)

summary(res_prad)


```

```{r}
res_prad %>% 
  filter(log2FoldChange  < -1, pvalue < 0.05)

## down 40, 41 up
```

```{r, message=FALSE, warning=FALSE, fig.width=8, fig.height=8}
res_prad %>% 
  filter(padj < 0.05) %>% 
  filter(abs(log2FoldChange) > 1)-> deg_all 

res_all2 <- deg_all %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = c("row"="geneID")) %>%  
  dplyr::select(geneName, stat) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(geneName) %>% 
  summarize(stat=mean(stat))

ranks <- deframe(res_all2)

register(SerialParam())

gsea_res <- fgsea(pathways=pathways_hallmark, stats=ranks)

fgseaResTidy <- gsea_res %>%
  as_tibble() %>%
  arrange(desc(NES))

hallmark <- fgseaResTidy %>% 
  filter(pval<0.05) %>% 
ggplot(aes(reorder(pathway, NES), NES)) +
  geom_col(fill="gray") +
  geom_text(aes(label = round(pval, 4)), size= 2)+
  coord_flip() +
  labs(title="Hallmark pathways") + 
  xlab("Pathways")+
  theme_minimal()+
   theme(text = element_text(size=8))

hallmark

```


```{r, message=FALSE, warning=FALSE, fig.width=12, fig.height=12}
register(SerialParam())

gsea_res <- fgsea(pathways=pathways_kegg, stats=ranks)

fgseaResTidy <- gsea_res %>%
  as_tibble() %>%
  arrange(desc(NES))

kegg <- fgseaResTidy %>% 
  filter(pval<0.05) %>% 
ggplot(aes(reorder(pathway, NES), NES)) +
  geom_col(fill="gray") +
  geom_text(aes(label = round(pval, 4)), size= 2)+
  coord_flip() +
  labs(title="KEGG pathways") +
  xlab("Pathways")+
  theme_minimal()+
   theme(text = element_text(size=8))

kegg
```

#### Construction of Subnetworks

```{r, message=FALSE, warning=FALSE, fig.align='center'}
cancer_cerna %>% 
  group_by(miRNAname, geneID) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  select(miRNAname, geneName) %>% 
  tidygraph::as_tbl_graph() ->cancer_gr


cancer_gr %>% 
  mutate(group=group_edge_betweenness()) ->cancer_gr


cancer_gr %>% 
  mutate(centrality = centrality_degree(mode = "all")) %>% 
  group_by(group) %>% 
  mutate(parcipitant = dplyr::row_number(),
         parcipitant=max(parcipitant)) %>% 
  ungroup() %>% 
  filter(parcipitant>2) %>% 
  mutate(type = ifelse(str_detect(name,"hsa"), "mirna", "competing")) ->cancer_gr2

cancer_gr2 %>% pull(group) %>% unique() -> group_v

for (i in group_v) {

graph <- cancer_gr2 %>% 
  mutate(name = str_remove(name, "hsa-")) %>% 
  filter(group==i) %>% 
  ggraph::ggraph(layout = "kk")+
  geom_edge_bend(color="grey")+
  geom_node_point(aes(filter=(type == "mirna")), shape=18, size = 7, color="navy", alpha = 0.7)+
  geom_node_point(aes(filter=(type == "competing")), shape=15, size = 7, color="chocolate4", alpha = 0.7)+
  geom_node_text(aes(filter=(type == "mirna"), label = name), color="midnightblue", size = 6, repel = TRUE)+
  geom_node_text(aes(filter=(type == "competing"), label = name), color="darkslategrey", size = 6, repel = TRUE)+
  #geom_node_label(aes(label = name, fill==type), color = "white", label.size = 0.50, size = 2)+
  theme_graph(base_family = "sans", plot_margin = margin(0, 0, 0, 0), title_margin = 2)+
  theme(legend.position = "none")

cancer_gr2 %>% 
  filter(group==i) %>% 
  filter(!str_detect(name, "hsa")) %>% 
  pull(name)->genes_part

dea_input %>% 
  mutate(row = row.names(.)) %>% 
  left_join(dplyr::select(cancer_cerna, geneID, geneName), by =c("row"="geneID")) %>% 
  distinct() %>% 
  select(geneName, contains("TCGA")) %>% 
  filter(geneName%in%genes_part) %>% 
  pivot_longer(contains("TCGA"), values_to = "exp", names_to = "samples")-> exp_graph


graph2 <- exp_graph %>% 
  left_join(coldata, by = c("samples"="sample_id")) %>% 
  ggplot(aes(x=geneName, y=log2(exp), fill=condition)) +
  geom_boxplot()+
  scale_fill_manual(values = c(normal = 'darkgreen', 
                               tumor = 'darkred'))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 60, hjust=1, size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.y = element_text(size = 20))+
  theme(legend.position = "none", axis.title.x = element_blank())

require(gridExtra)
graph3<- grid.arrange(graph, graph2, nrow=2)


ggsave(paste0("PRAD_vs_prostate_", i, ".svg"), plot = graph3, height = 7, width = 5)

}
 

```



### 3.3 BRCA:

```{r, message=FALSE, warning=FALSE}

length(intersect(unique(c(filter(cerna_pattern_cancer, tissue == "BRCA")$geneA, filter(cerna_pattern_cancer, tissue == "BRCA")$geneB)), unique(c(filter(cerna_pattern_normal, tissue == "BRCA")$geneA, filter(cerna_pattern_normal, tissue == "BRCA")$geneB))))

length(setdiff(unique(c(filter(cerna_pattern_cancer, tissue == "BRCA")$geneA, filter(cerna_pattern_cancer, tissue == "BRCA")$geneB)), unique(c(filter(cerna_pattern_normal, tissue == "BRCA")$geneA, filter(cerna_pattern_normal, tissue == "BRCA")$geneB))))

length(setdiff(unique(c(filter(cerna_pattern_normal, tissue == "BRCA")$geneA, filter(cerna_pattern_normal, tissue == "BRCA")$geneB)), unique(c(filter(cerna_pattern_cancer, tissue == "BRCA")$geneA, filter(cerna_pattern_cancer, tissue == "BRCA")$geneB))))

```

```{r, message=FALSE, warning=FALSE}
type <- "BRCA"

brca_specific <- setdiff(unique(c(filter(cerna_pattern_cancer, tissue == "BRCA")$geneA, filter(cerna_pattern_cancer, tissue == "BRCA")$geneB)), unique(c(filter(cerna_pattern_normal, tissue == "BRCA")$geneA, filter(cerna_pattern_normal, tissue == "BRCA")$geneB)))


cancer <- cerna_pattern_cancer %>% 
  filter(tissue == type) %>% 
  filter(geneA %in% brca_specific | geneB %in% brca_specific)
  

starbase_pairs %>% 
  filter(geneID %in% brca_specific) %>% 
  left_join(dplyr::select(all_starbase_data, miRNAid, miRNAname), by = "miRNAid") %>% 
  distinct() %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = "geneID") %>% 
  distinct()->cancer_cerna

cancer_cerna
```
#### BRCA DEG

Let's check the DEG profiles of the ceRNAs:

```{r, message=FALSE, warning=FALSE}

tcga_project_normal <-readRDS("data/tcga_project_normal.RDS") 

data_info_gen <- readRDS("data/data_info_gen.RDS")

all_tcga_normal <- as.data.frame(assay(tcga_project_normal))
rm(tcga_project_normal)
```


```{r, message=FALSE, warning=FALSE}

genes <- brca_specific

project_can <- "BRCA"

colnames(all_tcga_normal) <- substr(colnames(all_tcga_normal), 1,16) 

all_tcga_normal%>%
  dplyr::filter(!str_detect(row.names(.), "PAR")) %>% 
  mutate(gene_id = rownames(.)) %>% 
  separate(gene_id, into = c("ensemb_gene_id", "version")) %>% 
  dplyr::select(-version) ->all_tcga_normal

rownames(all_tcga_normal) <-all_tcga_normal$ensemb_gene_id

rownames(all_tcga_normal) <- str_trim(rownames(all_tcga_normal), side = "both")


all_tcga_normal %>% 
  dplyr::select(-ensemb_gene_id)-> all_tcga_normal



project_samples <- (data_info_gen %>% filter(str_detect(project, project_can)))$sample.submitter_id

all_tcga_normal %>% 
  dplyr::select(project_samples) %>% filter(rownames(.) %in% genes)-> all_tcga_normal


```

NOTE: These datasets have been uploaded to zenodo due to github size limitation. Download from the link.

```{r, message=FALSE, warning=FALSE}
log_new <- function(x){return(log2(x+1))}

string <- paste0("data/tcga_tumor_exp_", tolower(project_can), ".RDS")

readRDS(string)->project_tumor_exp

all_tcga_tumor <- as.data.frame(assay(project_tumor_exp))

rm(project_tumor_exp)


all_tcga_tumor%>%
  dplyr::select(contains("-01A-"))-> all_tcga_tumor
    
colnames(all_tcga_tumor)<- substr(colnames(all_tcga_tumor), 1,16)

colnames(all_tcga_tumor) %>% as_tibble() %>% group_by(value) %>% dplyr::count() %>% arrange(desc(n)) %>% filter(n>1) %>% pull(value)->discarded

all_tcga_tumor <- dplyr::select(all_tcga_tumor, -discarded)

all_tcga_tumor %>%  
  filter(!str_detect(row.names(.), "PAR")) %>% 
  mutate(gene_id = rownames(.)) %>% 
  separate(gene_id, into = c("ensemb_gene_id", "version")) %>% 
  dplyr::select(-version) %>% 
  filter(ensemb_gene_id %in% genes) %>% 
  group_by(ensemb_gene_id) %>% 
  mutate_at(vars(contains("TCGA")), .funs = max) %>% 
  ungroup() %>% 
  distinct() ->all_tcga_tumor

```

```{r, message=FALSE, warning=FALSE}

all_tcga_normal %>% 
  mutate(ensemb_gene_id =row.names(.)) %>% 
  left_join(all_tcga_tumor, by = "ensemb_gene_id")->dea_input

row.names(dea_input) <- dea_input$ensemb_gene_id

dplyr::select(dea_input, -ensemb_gene_id)->dea_input

```

```{r, message=FALSE, warning=FALSE}
data.frame(sample_id = c(colnames(dea_input))) %>% 
  mutate(condition = ifelse(str_detect(sample_id, paste(c("-11A", "-11B"),collapse = '|')), "normal", "tumor"))->coldata

row.names(coldata) <- coldata$sample_id

```


```{r, message=FALSE, warning=FALSE}
library(DESeq2)
dds <- DESeqDataSetFromMatrix(countData = round(dea_input),
                              colData = coldata,
                              design = ~ condition)


dds_brca <- DESeq(dds)
res_brca <- results(dds_brca, tidy = TRUE)

summary(res_brca)
```

```{r}
res_brca %>% 
  filter(log2FoldChange < -1, pvalue < 0.05)
```

```{r, message=FALSE, warning=FALSE, fig.width=8, fig.height=8}
res_brca %>% 
  filter(padj < 0.05) %>% 
  filter(abs(log2FoldChange) > 1)-> deg_all 

res_all2 <- deg_all %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = c("row"="geneID")) %>%  
  dplyr::select(geneName, stat) %>% 
  na.omit() %>% 
  distinct() %>% 
  group_by(geneName) %>% 
  summarize(stat=mean(stat))

ranks <- deframe(res_all2)

register(SerialParam())

gsea_res <- fgsea(pathways=pathways_hallmark, stats=ranks)

fgseaResTidy <- gsea_res %>%
  as_tibble() %>%
  arrange(desc(NES))

hallmark <- fgseaResTidy %>% 
  mutate(pathway = str_remove(pathway, "HALLMARK_")) %>% 
  filter(pval<0.05) %>% 
ggplot(aes(reorder(pathway, NES), NES)) +
  geom_point(aes(fill= pval, size = 1/pval)) +
  geom_label(aes(label = round(pval, 5)), size= 3, repel =TRUE, nudge_x = 0.3)+
  coord_flip() +
  labs(title="Hallmarks") + 
  theme_minimal()+
   theme(text = element_text(size=15, face = "bold"), legend.position = "none", axis.title.y = element_blank())

hallmark

```


```{r, message=FALSE, warning=FALSE, fig.width=12, fig.height=12}
register(SerialParam())

gsea_res <- fgsea(pathways=pathways_kegg, stats=ranks)

fgseaResTidy <- gsea_res %>%
  as_tibble() %>%
  arrange(desc(NES))

kegg <- fgseaResTidy %>% 
  mutate(pathway = str_remove(pathway, "KEGG_")) %>% 
  filter(pval<0.05) %>% 
  ggplot(aes(reorder(pathway, NES), NES)) +
  geom_point(aes(fill= pval, size = 1/pval)) +
  geom_label(aes(label = round(pval, 3)), size= 3, repel =TRUE, nudge_x = 0.3)+
  coord_flip() +
  labs(title="KEGG pathways") +
  xlab("Pathways")+
  theme_minimal()+
   theme(text = element_text(size=15, face = "bold"), legend.position = "none")

kegg

ggsave(paste0("brca_dea_hallmark.svg"), plot = hallmark,  height = 4, width = 12)
ggsave(paste0("brca_dea_kegg.svg"), plot = kegg, height = 4, width = 12)

```

```{r}
require(gridExtra)
graph_path<- grid.arrange(kegg, hallmark, ncol=2)

ggsave(paste0("brca_dea_genes.svg"), plot = graph_path,  height = 7, width = 12)
```

#### Construction of Subnetworks

```{r, message=FALSE, warning=FALSE, fig.align='center'}
cancer_cerna %>% 
  group_by(miRNAname, geneID) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  select(miRNAname, geneName) %>% 
  tidygraph::as_tbl_graph() ->cancer_gr


cancer_gr %>% 
  mutate(group=group_edge_betweenness()) ->cancer_gr


cancer_gr %>% 
  mutate(centrality = centrality_degree(mode = "all")) %>% 
  group_by(group) %>% 
  mutate(parcipitant = dplyr::row_number(),
         parcipitant=max(parcipitant)) %>% 
  ungroup() %>% 
  filter(parcipitant>2) %>% 
  mutate(type = ifelse(str_detect(name,"hsa"), "mirna", "competing")) ->cancer_gr2

cancer_gr2 %>% pull(group) %>% unique() -> group_v

for (i in group_v) {

graph <- cancer_gr2 %>% 
  mutate(name = str_remove(name, "hsa-")) %>% 
  filter(group==i) %>% 
  ggraph::ggraph(layout = "kk")+
  geom_edge_bend(color="grey")+
  geom_node_point(aes(filter=(type == "mirna")), shape=18, size = 7, color="navy", alpha = 0.7)+
  geom_node_point(aes(filter=(type == "competing")), shape=15, size = 7, color="chocolate4", alpha = 0.7)+
  geom_node_text(aes(filter=(type == "mirna"), label = name), color="midnightblue", size = 6, repel = TRUE)+
  geom_node_text(aes(filter=(type == "competing"), label = name), color="darkslategrey", size = 6, repel = TRUE)+
  theme_graph(base_family = "sans", plot_margin = margin(0, 0, 0, 0), title_margin = 2)+
  theme(legend.position = "none")

cancer_gr2 %>% 
  filter(group==i) %>% 
  filter(!str_detect(name, "hsa")) %>% 
  pull(name)->genes_part

dea_input %>% 
  mutate(row = row.names(.)) %>% 
  left_join(dplyr::select(cancer_cerna, geneID, geneName), by =c("row"="geneID")) %>% 
  distinct() %>% 
  select(geneName, contains("TCGA")) %>% 
  filter(geneName%in%genes_part) %>% 
  pivot_longer(contains("TCGA"), values_to = "exp", names_to = "samples")-> exp_graph


graph2 <- exp_graph %>% 
  left_join(coldata, by = c("samples"="sample_id")) %>% 
  ggplot(aes(x=geneName, y=log2(exp), fill=condition)) +
  geom_boxplot()+
  scale_fill_manual(values = c(normal = 'darkgreen', 
                               tumor = 'darkred'))+
  theme_classic()+
  theme(axis.text.x = element_text(angle = 60, hjust=1, size = 20),
        axis.text.y = element_text(size = 20),
        axis.title.y = element_text(size = 20))+
  theme(legend.position = "none", axis.title.x = element_blank())

require(gridExtra)
graph3<- grid.arrange(graph, graph2, nrow=2)

ggsave(paste0("BRCA_vs_breast_", i, ".svg"), plot = graph3, height = 7, width = 5)

}
 

```


-----------------

# CHAPTER3:

## Detecting common and distinct Fluctuating ceRNAs across 3 cancer types


```{r, message=FALSE, warning=FALSE}

cancer_luad <- setdiff(unique(c(filter(cerna_pattern_cancer, tissue == "LUAD")$geneA, filter(cerna_pattern_cancer, tissue == "LUAD")$geneB)), unique(c(filter(cerna_pattern_normal, tissue == "LUAD")$geneA, filter(cerna_pattern_normal, tissue == "LUAD")$geneB)))

cancer_prad <- setdiff(unique(c(filter(cerna_pattern_cancer, tissue == "PRAD")$geneA, filter(cerna_pattern_cancer, tissue == "PRAD")$geneB)), unique(c(filter(cerna_pattern_normal, tissue == "PRAD")$geneA, filter(cerna_pattern_normal, tissue == "PRAD")$geneB)))

cancer_brca <- setdiff(unique(c(filter(cerna_pattern_cancer, tissue == "BRCA")$geneA, filter(cerna_pattern_cancer, tissue == "BRCA")$geneB)), unique(c(filter(cerna_pattern_normal, tissue == "BRCA")$geneA, filter(cerna_pattern_normal, tissue == "BRCA")$geneB)))

```

### Venn diagram

```{r, message=FALSE, warning=FALSE}

library(ggVennDiagram)

ceRNA = list("LUAD" = cancer_luad, 
               "PRAD" = cancer_prad, 
               "BRCA" = cancer_brca)


venn1 <- ggVennDiagram(ceRNA, label = "count", set_size = 10, label_size = 12)+
  theme(legend.position="none", text = element_text(""), plot.margin = margin(10, 10, 10, 10, "mm"))+
  scale_fill_distiller(palette = "Blues", direction = 1)+
  scale_color_manual(values = c("LUAD" = "steelblue","PRAD" ="steelblue",'BRCA' = "steelblue"))

venn1

ggsave("all_three_samples_comparison.svg", height = 8, width = 8)
```

### Funtional Annotation of Common 90 genes:

```{r}
common_genes<- intersect(intersect(ceRNA$LUAD, ceRNA$PRAD), ceRNA$BRCA)
```
 
NOTE: Functional annotation for common genes was performed from the DAVID database. The results are compiled in the file **common_fa.txt**. 

```{r}
common_fa <- read_tsv("data/common_fa.txt")
```

```{r}
common_fa%>%
  janitor::clean_names() %>% 
  group_by(category) %>% 
  filter(p_value < 0.05) %>% 
  separate(term, into = c("code", "name"), sep = ":") %>% 
  separate(name, into = c("code", "name"), sep ="~") %>% 
  mutate(name = ifelse(is.na(name), code, name)) %>% 
  slice_max(order_by = fold_enrichment, n = 10) %>% 
  ungroup() %>% 
  ggplot(aes(x = fold_enrichment, y = name))+
  geom_point(aes(color = fold_enrichment, fill= category))+
  geom_text(aes(label=round(p_value, 5)), hjust = 0.9, color ="darkslategrey", size =3)+
  xlab("Fold Enrichment")+
  ylab("Annotation Term")+
  theme(panel.grid = element_blank(), axis.title = element_text(size =8), axis.text = element_text(size = 8),legend.position = "none")+
  facet_wrap(~category,  ncol=1, scales='free')
  
ggsave(filename = 'common_genes_go_terms.png', width = 10, height = 7)
```

### 4.1 LUAD DEG of 90 common genes

```{r, message=FALSE, warning=FALSE}

tcga_project_normal <-readRDS("data/tcga_project_normal.RDS")

data_info_gen <- readRDS("data/data_info_gen.RDS")

all_tcga_normal <- as.data.frame(assay(tcga_project_normal))
rm(tcga_project_normal)
```


```{r, message=FALSE, warning=FALSE}
project_can <- "LUAD"

colnames(all_tcga_normal) <- substr(colnames(all_tcga_normal), 1,16) 

all_tcga_normal%>%
  dplyr::filter(!str_detect(row.names(.), "PAR")) %>% 
  mutate(gene_id = rownames(.)) %>% 
  separate(gene_id, into = c("ensemb_gene_id", "version")) %>% 
  dplyr::select(-version) ->all_tcga_normal

rownames(all_tcga_normal) <-all_tcga_normal$ensemb_gene_id

rownames(all_tcga_normal) <- str_trim(rownames(all_tcga_normal), side = "both")


all_tcga_normal %>% 
  dplyr::select(-ensemb_gene_id)-> all_tcga_normal

project_samples <- (data_info_gen %>% filter(str_detect(project, project_can)))$sample.submitter_id

all_tcga_normal %>% 
  dplyr::select(project_samples) %>% filter(rownames(.) %in% common_genes)-> all_tcga_normal


```

NOTE: These datasets have been uploaded to zenodo due to github size limitation. Download from the link.

```{r, message=FALSE, warning=FALSE}
log_new <- function(x){return(log2(x+1))}

string <- paste0("data/tcga_tumor_exp_", tolower(project_can), ".RDS")

readRDS(string)->project_tumor_exp

all_tcga_tumor <- as.data.frame(assay(project_tumor_exp))

rm(project_tumor_exp)


all_tcga_tumor%>%
  dplyr::select(contains("-01A-"))-> all_tcga_tumor
    
colnames(all_tcga_tumor)<- substr(colnames(all_tcga_tumor), 1,16)

colnames(all_tcga_tumor) %>% as_tibble() %>% group_by(value) %>% dplyr::count() %>% arrange(desc(n)) %>% filter(n>1) %>% pull(value)->discarded

all_tcga_tumor <- dplyr::select(all_tcga_tumor, -discarded)

all_tcga_tumor %>%  
  filter(!str_detect(row.names(.), "PAR")) %>% 
  mutate(gene_id = rownames(.)) %>% 
  separate(gene_id, into = c("ensemb_gene_id", "version")) %>% 
  dplyr::select(-version) %>% 
  filter(ensemb_gene_id %in% common_genes) %>% 
  group_by(ensemb_gene_id) %>% 
  mutate_at(vars(contains("TCGA")), .funs = max) %>% 
  ungroup() %>% 
  distinct() ->all_tcga_tumor

```

```{r, message=FALSE, warning=FALSE}

all_tcga_normal %>% 
  mutate(ensemb_gene_id =row.names(.)) %>% 
  left_join(all_tcga_tumor, by = "ensemb_gene_id")->dea_input

row.names(dea_input) <- dea_input$ensemb_gene_id

dplyr::select(dea_input, -ensemb_gene_id)->dea_input


dea_input %>% 
  dplyr::select(!contains("-11B"))->dea_input

```

```{r, message=FALSE, warning=FALSE}
data.frame(sample_id = c(colnames(dea_input))) %>% 
  mutate(condition = ifelse(str_detect(sample_id, "-11A"), "normal", "tumor"))->coldata

row.names(coldata) <- coldata$sample_id

```


```{r, message=FALSE, warning=FALSE}

dds <- DESeqDataSetFromMatrix(countData = dea_input,
                              colData = coldata,
                              design = ~ condition)


dds_luad <- DESeq(dds)
res_luad <- results(dds_luad, tidy = TRUE)

summary(res_luad)
```

#### Heatmap of common 90 genes in LUAD:

```{r}
dds_norm <- rlog(dds_luad)
variances <- apply(assay(dds_norm), 1, var)
upper_var <- quantile(variances, 0.75)

df_by_var <- data.frame(assay(dds_norm)) %>%
  dplyr::filter(variances > upper_var)

df_by_var %>% 
  filter(row.names(.)%in% filter(res_luad, pvalue< 0.05)$row) -> df_by_var

dplyr::select(coldata, -sample_id)->meta_new

row.names(meta_new) <- str_replace_all(row.names(meta_new), "-", "\\.")

heatmap <- pheatmap(
  as.matrix(df_by_var),
  annotation_col = meta_new,
  cluster_rows = TRUE, # Cluster the rows of the heatmap (genes in this case)
  cluster_cols = FALSE, # Cluster the columns of the heatmap (samples),
  show_rownames = FALSE, # There are too many genes to clearly show the labels
  show_colnames = FALSE,color=colorRampPalette(c("navy", "white", "red"))(50),
  use_raster=FALSE,
  scale = "row" # Scale values in the direction of genes (rows)
)

ggsave("ceRNA_luad_commonn_three.svg", plot = heatmap,height = 3, width = 8)
```

### 4.2 PRAD DEG of 90 common genes

```{r, message=FALSE, warning=FALSE}

tcga_project_normal <-readRDS("data/tcga_project_normal.RDS")

data_info_gen <- readRDS("data/data_info_gen.RDS")

all_tcga_normal <- as.data.frame(assay(tcga_project_normal))
rm(tcga_project_normal)
```


```{r, message=FALSE, warning=FALSE}
project_can <- "PRAD"

colnames(all_tcga_normal) <- substr(colnames(all_tcga_normal), 1,16) 

all_tcga_normal%>%
  dplyr::filter(!str_detect(row.names(.), "PAR")) %>% 
  mutate(gene_id = rownames(.)) %>% 
  separate(gene_id, into = c("ensemb_gene_id", "version")) %>% 
  dplyr::select(-version) ->all_tcga_normal

rownames(all_tcga_normal) <-all_tcga_normal$ensemb_gene_id

rownames(all_tcga_normal) <- str_trim(rownames(all_tcga_normal), side = "both")


all_tcga_normal %>% 
  dplyr::select(-ensemb_gene_id)-> all_tcga_normal

project_samples <- (data_info_gen %>% filter(str_detect(project, project_can)))$sample.submitter_id

all_tcga_normal %>% 
  dplyr::select(project_samples) %>% filter(rownames(.) %in% common_genes)-> all_tcga_normal


```

NOTE: These datasets have been uploaded to zenodo due to github size limitation. Download from the link.

```{r, message=FALSE, warning=FALSE}
log_new <- function(x){return(log2(x+1))}

string <- paste0("data/tcga_tumor_exp_", tolower(project_can), ".RDS")

readRDS(string)->project_tumor_exp

all_tcga_tumor <- as.data.frame(assay(project_tumor_exp))

rm(project_tumor_exp)


all_tcga_tumor%>%
  dplyr::select(contains("-01A-"))-> all_tcga_tumor
    
colnames(all_tcga_tumor)<- substr(colnames(all_tcga_tumor), 1,16)

colnames(all_tcga_tumor) %>% as_tibble() %>% group_by(value) %>% dplyr::count() %>% arrange(desc(n)) %>% filter(n>1) %>% pull(value)->discarded

all_tcga_tumor <- dplyr::select(all_tcga_tumor, -discarded)

all_tcga_tumor %>%  
  filter(!str_detect(row.names(.), "PAR")) %>% 
  mutate(gene_id = rownames(.)) %>% 
  separate(gene_id, into = c("ensemb_gene_id", "version")) %>% 
  dplyr::select(-version) %>% 
  filter(ensemb_gene_id %in% common_genes) %>% 
  group_by(ensemb_gene_id) %>% 
  mutate_at(vars(contains("TCGA")), .funs = max) %>% 
  ungroup() %>% 
  distinct() ->all_tcga_tumor

```

```{r, message=FALSE, warning=FALSE}

all_tcga_normal %>% 
  mutate(ensemb_gene_id =row.names(.)) %>% 
  left_join(all_tcga_tumor, by = "ensemb_gene_id")->dea_input

row.names(dea_input) <- dea_input$ensemb_gene_id

dplyr::select(dea_input, -ensemb_gene_id)->dea_input

dea_input %>% 
  dplyr::select(!contains("-11B")) %>% 
  dplyr::select(!contains("-01B"))-> dea_input

```

```{r, message=FALSE, warning=FALSE}
data.frame(sample_id = c(colnames(dea_input))) %>% 
  mutate(condition = ifelse(str_detect(sample_id, "-11A"), "normal", "tumor"))->coldata

row.names(coldata) <- coldata$sample_id

```


```{r, message=FALSE, warning=FALSE}
library(DESeq2)
dds <- DESeqDataSetFromMatrix(countData = dea_input,
                              colData = coldata,
                              design = ~ condition)


dds_prad <- DESeq(dds)
res_prad <- results(dds_prad, tidy = TRUE)

summary(res_prad)
```

#### Heatmap of common 90 genes in PRAD:

```{r}
dds_norm <- rlog(dds_prad)
variances <- apply(assay(dds_norm), 1, var)
upper_var <- quantile(variances, 0.75)

df_by_var <- data.frame(assay(dds_norm)) %>%
  dplyr::filter(variances > upper_var)

df_by_var %>% 
  filter(row.names(.)%in% filter(res_prad, pvalue< 0.05)$row) -> df_by_var

dplyr::select(coldata, -sample_id)->meta_new

row.names(meta_new) <- str_replace_all(row.names(meta_new), "-", "\\.")

heatmap <- pheatmap(
  as.matrix(df_by_var),
  annotation_col = meta_new,
  cluster_rows = TRUE, # Cluster the rows of the heatmap (genes in this case)
  cluster_cols = FALSE, # Cluster the columns of the heatmap (samples),
  show_rownames = FALSE, # There are too many genes to clearly show the labels
  show_colnames = FALSE,color=colorRampPalette(c("navy", "white", "red"))(50),
  use_raster=FALSE,
  scale = "row" # Scale values in the direction of genes (rows)
)

ggsave("ceRNA_prad_commonn_three.svg", plot = heatmap,height = 3, width = 8)
```

### 4.3 BRCA DEG of 90 common genes

```{r, message=FALSE, warning=FALSE}

tcga_project_normal <-readRDS("data/tcga_project_normal.RDS")

data_info_gen <- readRDS("data/data_info_gen.RDS")

all_tcga_normal <- as.data.frame(assay(tcga_project_normal))
rm(tcga_project_normal)
```


```{r, message=FALSE, warning=FALSE}
project_can <- "BRCA"

colnames(all_tcga_normal) <- substr(colnames(all_tcga_normal), 1,16) 

all_tcga_normal%>%
  dplyr::filter(!str_detect(row.names(.), "PAR")) %>% 
  mutate(gene_id = rownames(.)) %>% 
  separate(gene_id, into = c("ensemb_gene_id", "version")) %>% 
  dplyr::select(-version) ->all_tcga_normal

rownames(all_tcga_normal) <-all_tcga_normal$ensemb_gene_id

rownames(all_tcga_normal) <- str_trim(rownames(all_tcga_normal), side = "both")


all_tcga_normal %>% 
  dplyr::select(-ensemb_gene_id)-> all_tcga_normal

project_samples <- (data_info_gen %>% filter(str_detect(project, project_can)))$sample.submitter_id

all_tcga_normal %>% 
  dplyr::select(project_samples) %>% filter(rownames(.) %in% common_genes)-> all_tcga_normal


```

NOTE: These datasets have been uploaded to zenodo due to github size limitation. Download from the link.

```{r, message=FALSE, warning=FALSE}
log_new <- function(x){return(log2(x+1))}

string <- paste0("data/tcga_tumor_exp_", tolower(project_can), ".RDS")

readRDS(string)->project_tumor_exp

all_tcga_tumor <- as.data.frame(assay(project_tumor_exp))

rm(project_tumor_exp)


all_tcga_tumor%>%
  dplyr::select(contains("-01A-"))-> all_tcga_tumor
    
colnames(all_tcga_tumor)<- substr(colnames(all_tcga_tumor), 1,16)

colnames(all_tcga_tumor) %>% as_tibble() %>% group_by(value) %>% dplyr::count() %>% arrange(desc(n)) %>% filter(n>1) %>% pull(value)->discarded

all_tcga_tumor <- dplyr::select(all_tcga_tumor, -discarded)

set.seed(123)
sample(colnames(all_tcga_tumor), 500)

all_tcga_tumor %>%  
  filter(!str_detect(row.names(.), "PAR")) %>% 
  mutate(gene_id = rownames(.)) %>% 
  separate(gene_id, into = c("ensemb_gene_id", "version")) %>% 
  dplyr::select(-version) %>% 
  filter(ensemb_gene_id %in% common_genes) %>% 
  group_by(ensemb_gene_id) %>% 
  mutate_at(vars(contains("TCGA")), .funs = max) %>% 
  ungroup() %>% 
  select(ensemb_gene_id, sample(colnames(all_tcga_tumor), 500)) %>% 
  distinct() ->all_tcga_tumor

```

```{r, message=FALSE, warning=FALSE}

all_tcga_normal %>% 
  mutate(ensemb_gene_id =row.names(.)) %>% 
  left_join(all_tcga_tumor, by = "ensemb_gene_id")->dea_input

row.names(dea_input) <- dea_input$ensemb_gene_id

dplyr::select(dea_input, -ensemb_gene_id)->dea_input

dea_input %>% 
  dplyr::select(!contains("-11B")) %>% 
  dplyr::select(!contains("-01B"))->dea_input

```

```{r, message=FALSE, warning=FALSE}
data.frame(sample_id = c(colnames(dea_input))) %>% 
  mutate(condition = ifelse(str_detect(sample_id, "-11A"), "normal", "tumor"))->coldata

row.names(coldata) <- coldata$sample_id

```


```{r, message=FALSE, warning=FALSE}
library(DESeq2)
dds <- DESeqDataSetFromMatrix(countData = dea_input,
                              colData = coldata,
                              design = ~ condition)


dds_brca <- DESeq(dds)
res_brca <- results(dds_brca, tidy = TRUE)

summary(res_brca)
```

#### Heatmap of common 90 genes in BRCA:

```{r}
dds_norm <- rlog(dds_brca)
variances <- apply(assay(dds_norm), 1, var)
upper_var <- quantile(variances, 0.75)

df_by_var <- data.frame(assay(dds_norm)) %>%
  dplyr::filter(variances > upper_var)

df_by_var %>% 
  filter(row.names(.)%in% filter(res_brca, pvalue< 0.05)$row) -> df_by_var

dplyr::select(coldata, -sample_id)->meta_new

row.names(meta_new) <- str_replace_all(row.names(meta_new), "-", "\\.")

heatmap <- pheatmap(
  as.matrix(df_by_var),
  annotation_col = meta_new,
  cluster_rows = TRUE, # Cluster the rows of the heatmap (genes in this case)
  cluster_cols = FALSE, # Cluster the columns of the heatmap (samples),
  show_rownames = FALSE, # There are too many genes to clearly show the labels
  show_colnames = FALSE,
  main = "Expression profile of Common ceRNAs in three tissues: BRCA vs breast samples",color=colorRampPalette(c("navy", "white", "red"))(50),
  use_raster=FALSE,
  scale = "row" # Scale values in the direction of genes (rows)
)

ggsave("ceRNA_brca_commonn_three.svg", plot = heatmap,height = 3, width = 8)
```


# IDENTIFICATION THE CORE MIRNA:CERNA INTERACTION NETWORK


```{r}

starbase_pairs %>% 
  filter(geneID%in% unique(common_genes)) %>% 
  left_join(dplyr::select(all_starbase_data, miRNAid, miRNAname), by = "miRNAid") %>% 
  distinct() %>% 
  left_join(dplyr::select(all_starbase_data, geneID, geneName), by = "geneID") %>% 
  distinct()->common_cancer_cerna

common_cancer_cerna %>% 
  group_by(miRNAname, geneID) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  select(miRNAname, geneName) %>% 
  tidygraph::as_tbl_graph() ->cancer_gr

cancer_gr %>% 
  mutate(group=group_edge_betweenness()) ->cancer_gr

```


```{r}
cancer_gr %>% 
  mutate(centrality = centrality_degree(mode = "all")) %>% 
  group_by(group) %>% 
  mutate(parcipitant = dplyr::row_number(),
         parcipitant=max(parcipitant)) %>% 
  ungroup() %>% 
  filter(parcipitant>=2) %>% 
  mutate(type = ifelse(str_detect(name,"hsa"), "mirna", "competing")) ->cancer_gr2


cancer_gr2 %>% pull(group) %>% unique() -> group_v
```


```{r}
svg("common_ceRNA_overall_circlize.svg", height = 25, width = 25)

cancer_gr2 %>%
  activate(edges) %>% 
  left_join(dplyr::select(mutate(as_tibble(cancer_gr2) , no =row_number()), no, name), by = c("to"="no")) %>% 
  left_join(dplyr::select(mutate(as_tibble(cancer_gr2) , no =row_number()), no, name), by = c("from"="no"), suffix = c("_to","_from")) %>% 
  group_by(to) %>% 
  mutate(row=row_number(), row = max(row)) %>% 
  ungroup() %>% 
  as_tibble() %>% 
  mutate(name_from = str_remove(name_from, "hsa-")) %>% 
  dplyr::select(name_from, name_to) %>% 
  chordDiagram(annotationTrack = "grid", preAllocateTracks = list(track.height = 0.1))
circos.trackPlotRegion(track.index = 1, panel.fun = function(x, y) {
  xlim = get.cell.meta.data("xlim")
  xplot = get.cell.meta.data("xplot")
  ylim = get.cell.meta.data("ylim")
  sector.name = get.cell.meta.data("sector.index")
  if(abs(xplot[2] - xplot[1]) < 10) {
    circos.text(mean(xlim), ylim[1], sector.name, facing = "clockwise",
                niceFacing = TRUE, adj = c(0, 0.5))
  } else {
    circos.text(mean(xlim), ylim[1], sector.name, facing = "inside",
                niceFacing = TRUE, adj = c(0.5, 0))
  }
}, bg.border = NA)


dev.off()
```


#### COMMON SPESIFIC ceRNA PROFILES IN THREE CANCER TYPES:::

```{r}
res_luad %>% 
  dplyr::select(row, log2FoldChange, pvalue) %>% 
  left_join(dplyr::select(res_prad, row, log2FoldChange, pvalue), by = "row", suffix= c("_luad", "_prad")) %>% 
  left_join(dplyr::select(res_brca, row, log2FoldChange, pvalue), by = "row") %>% 
  rename("log2FoldChange"="log2FoldChange_brca", "pvalue"="pvalue_brca", "row"="gene_id") %>% 
  left_join(distinct(dplyr::select(all_starbase_data, geneID, geneName)), by =c("gene_id"= "geneID")) %>% 
  distinct() %>% 
  group_by(gene_id) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  dplyr::select(gene_id, geneName, contains("log2FoldChange")) %>% 
  arrange(desc(log2FoldChange_luad))
```

```{r}
res_luad %>% 
  dplyr::select(row, log2FoldChange, pvalue) %>% 
  left_join(dplyr::select(res_prad, row, log2FoldChange, pvalue), by = "row", suffix= c("_luad", "_prad")) %>% 
  left_join(dplyr::select(res_brca, row, log2FoldChange, pvalue), by = "row") %>% 
  rename("log2FoldChange"="log2FoldChange_brca", "pvalue"="pvalue_brca", "row"="gene_id") %>% 
  left_join(distinct(dplyr::select(all_starbase_data, geneID, geneName)), by =c("gene_id"= "geneID")) %>% 
  distinct() %>% 
  group_by(gene_id) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  dplyr::select(gene_id, geneName, contains("log2FoldChange")) %>% 
  arrange(desc(log2FoldChange_prad))
```


```{r}
res_luad %>% 
  dplyr::select(row, log2FoldChange, pvalue) %>% 
  left_join(dplyr::select(res_prad, row, log2FoldChange, pvalue), by = "row", suffix= c("_luad", "_prad")) %>% 
  left_join(dplyr::select(res_brca, row, log2FoldChange, pvalue), by = "row") %>% 
  rename("log2FoldChange"="log2FoldChange_brca", "pvalue"="pvalue_brca", "row"="gene_id") %>% 
  left_join(distinct(dplyr::select(all_starbase_data, geneID, geneName)), by =c("gene_id"= "geneID")) %>% 
  distinct() %>% 
  group_by(gene_id) %>% 
  mutate(row_number()) %>% 
  filter(row_number()==1) %>% 
  ungroup() %>% 
  dplyr::select(gene_id, geneName, contains("log2FoldChange")) %>% 
  arrange(desc(-log2FoldChange_brca))
```
